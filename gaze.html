<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>WebGazer ä¹ç‚¹æ ¡å‡†ä¸éªŒè¯å®éªŒ</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body {
      text-align: center;
      background: #f8f8f8;
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }
    .dot {
      width: 24px;
      height: 24px;
      background: red;
      border-radius: 50%;
      position: fixed;
      display: none;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 0 10px rgba(255,0,0,0.5);
    }
    #instructions {
      margin-top: 30px;
      font-size: 18px;
      z-index: 9999;
      position: relative;
    }
    button {
      display: none;
      margin-top: 30px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      position: relative;
      z-index: 9999;
    }
    #exportBtn { background: #4CAF50; color:white; }
    #recalibrateBtn { background: #f44336; margin-left:10px; color:white; }
    #validateBtn { background: #2196F3; margin-left:10px; color:white; }
  </style>
</head>
<body>
  <h1>WebGazer ä¹ç‚¹æ ¡å‡†ä¸éªŒè¯å®éªŒ</h1>
  <p id="instructions">
    è¯·å…è®¸æ‘„åƒå¤´è®¿é—®ã€‚<br>
    æ ¡å‡†æ—¶ï¼Œè¯·æ³¨è§†å±å¹•ä¸Šå‡ºç°çš„çº¢ç‚¹ï¼Œå¹¶åœ¨æ³¨è§†çº¢ç‚¹ä¸­å¤®æ—¶ç‚¹å‡»å®ƒã€‚
  </p>

  <button id="exportBtn">å¯¼å‡ºæ•°æ® (CSV)</button>
  <button id="recalibrateBtn">é‡æ–°æ ¡å‡†</button>
  <button id="validateBtn">å¼€å§‹éªŒè¯</button>

  <script>
    // ===== å…¨å±€å˜é‡ =====
    let gazeData = [];
    let calibrationCount = 0;
    let tracking = false;
    const dots = [];
    const calibrationErrors = [];
    const validationData = [];
    const validationErrors = [];

    const calibrationPositions = [
      [0.1,0.1],[0.5,0.1],[0.9,0.1],
      [0.1,0.5],[0.5,0.5],[0.9,0.5],
      [0.1,0.9],[0.5,0.9],[0.9,0.9]
    ];

    const validationPositions = [
      [0.1, 0.1],[0.9,0.1],[0.1,0.9],[0.9,0.9],[0.5,0.5]
    ];

    // ===== åˆ›å»ºä¹ä¸ªæ ¡å‡†ç‚¹ =====
    function createDots() {
      calibrationPositions.forEach((pos,i)=>{
        const dot = document.createElement('div');
        dot.classList.add('dot');
        dot.style.left = `${pos[0]*window.innerWidth-12}px`;
        dot.style.top = `${pos[1]*window.innerHeight-12}px`;

        dot.onclick = async ()=>{
          const prediction = await webgazer.getCurrentPrediction();
          if(!prediction){
            alert("è¯·æ³¨è§†çº¢ç‚¹ä¸­å¤®åå†ç‚¹å‡»ï¼");
            return;
          }
          const dx = prediction.x - pos[0]*window.innerWidth;
          const dy = prediction.y - pos[1]*window.innerHeight;
          const distance = Math.sqrt(dx*dx + dy*dy);

          if(distance<200){
            calibrationErrors.push(distance);
            calibrationCount++;
            dot.style.display='none';
            if(calibrationCount<dots.length){
              dots[calibrationCount].style.display='block';
            } else {
              showCalibrationResult();
              startTracking();
            }
          } else {
            alert("è¯·æ³¨è§†çº¢ç‚¹ä¸­å¤®åå†ç‚¹å‡»ï¼");
          }
        };

        document.body.appendChild(dot);
        dots.push(dot);
      });
    }

    createDots();

    // ===== åˆå§‹åŒ– WebGazer =====
    window.onload = async () => {
      await webgazer.setRegression('ridge')
        .setGazeListener((data, timestamp)=>{
          if(data && tracking){
            const now = new Date();
            const bjTime = new Date(now.getTime()+8*60*60*1000)
              .toISOString().replace('T',' ').replace('Z','');
            gazeData.push({
              time_local: bjTime,
              x:data.x,
              y:data.y
            });
          }
        })
        .begin();

      setTimeout(()=>{
        const video = document.getElementById('webgazerVideoFeed');
        const overlay = document.getElementById('webgazerVideoOverlay');
        if(video) video.style.zIndex=1;
        if(overlay) overlay.style.zIndex=2;
      },1500);

      dots[0].style.display='block';
    };

    // ===== æ ¡å‡†ç»“æœæ˜¾ç¤º =====
    function showCalibrationResult(){
      const sum = calibrationErrors.reduce((a,b)=>a+b,0);
      const avg = (sum/calibrationErrors.length).toFixed(2);
      document.getElementById('instructions').innerHTML=
        `âœ… æ ¡å‡†å®Œæˆï¼<br>`+
        `æ¯ä¸ªç‚¹è¯¯å·®(px)ï¼š${calibrationErrors.map(d=>d.toFixed(2)).join(', ')}<br>`+
        `å¹³å‡æ ¡å‡†è¯¯å·®ï¼š${avg} px<br>`+
        `è¯·ä¿æŒè‡ªç„¶æ³¨è§†å±å¹•ï¼Œç³»ç»Ÿæ­£åœ¨è®°å½•æ‚¨çš„æ³¨è§†ç‚¹...`;
    }

    // ===== å¼€å§‹æ³¨è§†è¿½è¸ª =====
    function startTracking(){
      tracking = true;
      setTimeout(()=>{
        document.getElementById('exportBtn').style.display='inline-block';
        document.getElementById('recalibrateBtn').style.display='inline-block';
        document.getElementById('validateBtn').style.display='inline-block';
      },5000);
    }

    // ===== éªŒè¯é€»è¾‘ =====
    const validateDot = document.createElement('div');
    validateDot.classList.add('dot');
    document.body.appendChild(validateDot);

    function startValidation(){
      let index=0;

      function showNextDot(){
        if(index>=validationPositions.length){
          showValidationResult();
          return;
        }

        const pos = validationPositions[index];
        validateDot.style.left = `${pos[0]*window.innerWidth-12}px`;
        validateDot.style.top = `${pos[1]*window.innerHeight-12}px`;
        validateDot.style.display='block';

        setTimeout(()=>{
          let t=0;
          const interval = setInterval(async ()=>{
            t+=100;
            const pred = await webgazer.getCurrentPrediction();
            if(pred){
              validationData.push({
                point:index+1,
                x_real: pos[0]*window.innerWidth,
                y_real: pos[1]*window.innerHeight,
                x_pred: pred.x,
                y_pred: pred.y,
                time: new Date().toISOString()
              });
            }
            if(t>=3000){
              clearInterval(interval);
              index++;
              validateDot.style.display='none';
              showNextDot();
            }
          },100);
        },1000);
      }

      showNextDot();
    }

    function showValidationResult(){
      validationErrors.length=0;
      validationPositions.forEach((pos,i)=>{
        const points = validationData.filter(d=>d.point===i+1);
        if(points.length>0){
          const avgX = points.reduce((a,b)=>a+b.x_pred,0)/points.length;
          const avgY = points.reduce((a,b)=>a+b.y_pred,0)/points.length;
          const dx = avgX - pos[0]*window.innerWidth;
          const dy = avgY - pos[1]*window.innerHeight;
          const dist = Math.sqrt(dx*dx+dy*dy);
          validationErrors.push(dist);
        } else validationErrors.push(NaN);
      });
      const avg = (validationErrors.reduce((a,b)=>a+b,0)/validationErrors.length).toFixed(2);
      document.getElementById('instructions').innerHTML=
        `âœ… éªŒè¯å®Œæˆï¼<br>`+
        `æ¯ä¸ªç‚¹è¯¯å·®(px)ï¼š${validationErrors.map(d=>d.toFixed(2)).join(', ')}<br>`+
        `å¹³å‡éªŒè¯è¯¯å·®ï¼š${avg} px`;
    }

    document.getElementById('validateBtn').onclick = ()=>startValidation();

    // ===== å¯¼å‡º CSV =====
    document.getElementById('exportBtn').onclick = ()=>{
      let csvContent = "data:text/csv;charset=utf-8,";
      // æ³¨è§†è½¨è¿¹
      csvContent+="time_local(åŒ—äº¬æ—¶é—´),x,y\n";
      csvContent+=gazeData.map(d=>`${d.time_local},${d.x.toFixed(2)},${d.y.toFixed(2)}`).join("\n");
      csvContent+="\n\n";

      // æ ¡å‡†è¯¯å·®
      csvContent+="ç‚¹ç¼–å·,è¯¯å·®(px)\n";
      calibrationErrors.forEach((err,i)=>csvContent+=`${i+1},${err.toFixed(2)}\n`);
      const avgCal = (calibrationErrors.reduce((a,b)=>a+b,0)/calibrationErrors.length).toFixed(2);
      csvContent+=`å¹³å‡æ ¡å‡†è¯¯å·®,${avgCal}\n\n`;

      // éªŒè¯è¯¯å·®
      csvContent+="éªŒè¯ç‚¹ç¼–å·,è¯¯å·®(px)\n";
      validationErrors.forEach((err,i)=>csvContent+=`${i+1},${err.toFixed(2)}\n`);
      const avgVal = (validationErrors.reduce((a,b)=>a+b,0)/validationErrors.length).toFixed(2);
      csvContent+=`å¹³å‡éªŒè¯è¯¯å·®,${avgVal}\n`;

      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download","gaze_data_full.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // ===== é‡æ–°æ ¡å‡† =====
    document.getElementById('recalibrateBtn').onclick = ()=>{
      tracking=false;
      gazeData=[];
      calibrationCount=0;
      calibrationErrors.length=0;
      validationData.length=0;
      validationErrors.length=0;
      dots.forEach(dot=>dot.remove());
      dots.length=0;
      createDots();
      document.getElementById('instructions').innerHTML=
        "ğŸ” é‡æ–°æ ¡å‡†ï¼šè¯·æ³¨è§†å±å¹•ä¸Šå‡ºç°çš„çº¢ç‚¹ï¼Œå¹¶åœ¨æ³¨è§†çº¢ç‚¹ä¸­å¤®æ—¶ç‚¹å‡»å®ƒã€‚";
      document.getElementById('exportBtn').style.display='none';
      document.getElementById('recalibrateBtn').style.display='none';
      document.getElementById('validateBtn').style.display='none';
      dots[0].style.display='block';
    };
  </script>
</body>
</html>
